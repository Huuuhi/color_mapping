

## 简介

颜色映射（Color mapping）是一种常见的标量可视化技术，它将标量数据映射到颜色，并显示颜色在计算机系统上。 

详见[VTK TextBook](https://gitlab.kitware.com/vtk/textbook/raw/master/VTKBook/VTKTextBook.pdf)一书的`6.2.1 Color Mapping` 章节

第一张 shader生成颜色

查找表

## 目标

创建流场数据结构（建议从[CGNS文件](https://cgns.github.io/CGNSFiles.html)读取流场数据，其他文件格式或模拟数据亦可），包含几何、拓扑和至少一组顶点标量数据，使用 `OpenGL API` 进行图形渲染，其中标量数值到颜色的映射需在着色器程序中实现。



[VTK扩展CGNS网格读取](https://zhuanlan.zhihu.com/p/376790346)

[VS2019中配置VTK8.2.0](https://blog.csdn.net/t18438605018/article/details/122050211) 

[VTK+VS2019(或其他版本均可) 傻瓜式一站式 配置](https://blog.csdn.net/GENGXINGGUANG/article/details/106820207?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-106820207-blog-122050211.235%5Ev35%5Epc_relevant_increate_t0_download_v2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-106820207-blog-122050211.235%5Ev35%5Epc_relevant_increate_t0_download_v2&utm_relevant_index=2) 



[vtk+python ](https://zhuanlan.zhihu.com/p/402564889) 

[vtk+contour](https://zhuanlan.zhihu.com/p/449892284)



[marching cube algorithm](https://zhuanlan.zhihu.com/p/48022195) 

[algorithm 2](https://zhuanlan.zhihu.com/p/561731427) 

[marching cube video](https://www.bilibili.com/video/BV1yJ411r73v/?spm_id_from=autoNext&vd_source=ed20590ec12310eedb2e909f7c1a001e) 

 

[assimp](https://blog.csdn.net/ycrsw/article/details/124917424) 

[assimp安装](https://www.jianshu.com/p/4f3a1271ce0b)  





### 6.1.1 通用性与效率 

大多数算法可以针对特定的数据集类型编写，或者更一般地处理任何数据集类型。 特定算法的优点是它通常比可比较的通用算法更快。（请参阅第137页上讨论抽象和具体形式之间的权衡“其他数据抽象”）。特定算法的实现也可能更加内存高效，并且其实现可能更好地反映算法与数据集类型之间的关系。 一个例子是等高线表面创建。提取等高线表面的算法最初是为体数据开发的，主要用于医学应用。体积的规则性适合于高效的算法。然而，以体积为基础的算法的专业化排除了它们在更一般的数据集类型（如结构化或非结构化网格）中的使用。虽然等高线算法可以适应这些其他数据集类型，但它们的效率低于针对体积数据集的算法。 我们的算法介绍更倾向于更一般的实现。在一些特殊情况下，我们会描述特定数据集类型的性能改进技术。有关专业算法的详细描述，请参阅每章末尾的参考书目。

## 6.2 标量算法 

标量是与数据集的每个点和/或单元格关联的单个数据值。（请回想一下，在可视化工具包中我们将数据与点相关联。）由于标量数据在现实世界中非常常见，而且处理标量数据非常容易，因此有许多不同的算法可以对其进行可视化。

### 6.2.1 颜色映射 

颜色映射是一种常见的标量可视化技术，它将标量数据映射到颜色，并在计算机系统上显示颜色。标量映射是通过索引到颜色查找表来实现的。标量值用作查找表中的索引。 映射过程如下所示。查找表保存颜色数组（例如，红色、绿色、蓝色组件或其他可比较的表示）。与表相关联的是一个最小和最大标量范围（min，max），其中标量值被映射到范围内。大于最大范围的标量值被夹紧到最大颜色，小于最小范围的标量值被夹紧到最小颜色值。然后，对于每个标量值xi，具有n个条目的颜色表（以0为偏移）中的索引i由图6.1给出。 查找表的一种更一般形式称为传递函数。传递函数是将标量值映射到颜色规范的任何表达式。例如，图6.2将标量值映射到红、绿、蓝颜色分量的单独强度值。我们还可以使用传递函数将标量数据映射到其他信息，如局部透明度。（传递函数在“透明度和Alpha值”第209页和“体积渲染”第213页中有更详细的讨论）。查找表是传递函数的离散采样。我们可以通过在一组离散点上采样传递函数来创建查找表。

颜色映射是一种一维可视化技术，它将一条信息（即标量值）映射到颜色规范上。然而，颜色信息的显示不限于一维显示。通常，我们使用映射到一维、二维或三维对象上的颜色信息。这是增加可视化信息内容的简单方法。

标量可视化的关键是要精心选择查找表条目。图6.3展示了用于可视化燃烧室内气体密度的四个不同查找表。第一个查找表是灰度查找表。灰度查找表通常为眼睛提供更好的结构细节。图6.3中的其他三幅图像使用了不同的彩色查找表。第二个使用从蓝到红的彩虹色调。第三个使用从红到蓝排列的彩虹色调。最后一个查找表使用了一个设计用于增强对比度的表。精心使用颜色通常可以增强数据集的重要特征。然而，任何类型的查找表都可能夸大不重要的细节或创建视觉伪像，因为数据、颜色选择和人体生理之间可能出现意想不到的相互作用。

设计查找表既是一门艺术，也是一门科学。从实际角度来看，查找表应该强调重要特征，同时尽量减少不重要或多余的细节。使用内在包含缩放信息的调色板也是理想的。例如，通常使用从蓝到红的彩虹色标来表示温度标度，因为许多人将“蓝色”与低温度联系起来，“红色”与高温度联系起来。然而，即使这种比例也存在问题：物理学家会说，蓝色比红色更热，因为更热的物体会放出更多的蓝光（即更短的波长）。此外，没有必要限制自己使用“线性”查找表。尽管标量到颜色的映射被呈现为线性操作（如图6.1所示），但查找表本身不需要是线性的。也就是说，可以设计表来使用对数或其他方案增强标量值的微小变化，提高舒适度并更深入地吸引人类观察者参与数据呈现，从而提高通信的效果。

### 6.2.2 等值线 

颜色映射的一个自然扩展是等值线（contouring）。当我们看到表面被数据值着色时，眼睛常常将相似颜色的区域分为不同的区域。当我们对数据进行等值线处理时，实际上是在构造这些区域之间的边界。这些边界对应于常量标量值的等值线（2D）或等值面（3D）。

2D等值线显示的示例包括标有恒定温度线（等温线）的天气图，或用恒定海拔高度线绘制的地形图。三维等值线称为等值面，可以由许多多边形基元近似。等值面的示例包括与身体组织（如皮肤、骨骼或其他器官）相对应的医学图像强度常数。还可以创建其他抽象的等值面，例如在流体流动中的恒定压力或温度的表面。

考虑图6.4中显示的2D结构化网格。在定义网格的点旁边显示标量值。等值线始终从选择对应于生成的等值线或等值面的等值标量值开始。为了生成等值线，必须使用某种形式的插值。这是因为在数据集中只有一组有限的点具有标量值，而我们的等值标量值可能位于这些点之间。由于最常见的插值技术是线性的，因此我们通过沿边进行线性插值来生成等值线上的点。如果一条边的两个端点具有标量值10和0，并且我们试图生成值为5的等值线，则边插值会计算等值线通过边的中点。

一旦生成了单元边缘上的点，就可以使用几种不同的方法将这些点连接成等高线。一种方法是检测边缘交叉点（即等高线穿过一条边缘），然后“跟踪”这条等高线穿过单元边界的轨迹。我们知道，如果等高线进入单元，则它也必须从单元中退出。等高线被跟踪，直到它闭合回到自己的起点，或者退出数据集边界。如果已知只存在一个等高线，则该过程停止。否则，必须检查数据集中的每个边缘，以查看是否存在其他等高线。 另一种方法使用分治技术，独立处理单元。这是二维中的Marching Squares算法和三维中的Marching Cubes算法。这些技术的基本假设是等高线只能以有限的方式穿过单元。构建一个情况表，列出单元点的标量值组合所对应的所有可能的拓扑状态。拓扑状态的数量取决于单元顶点的数量以及顶点相对于等高线值的内部/外部关系的数量。如果顶点的标量值大于等高线的标量值，则将其视为等高线内部的顶点。标量值小于等高线值的顶点被认为是等高线外部的顶点。例如，如果一个单元有四个顶点，每个顶点可以在等高线内部或外部，则等高线穿过该单元的可能方式有16种，即24。在情况表中，我们不关心等高线穿过单元的位置（例如，几何交点），只关心等高线在单元中穿过的方式（即等高线在单元中的拓扑结构）。

图6.5展示了一个正方形单元格的16种组合。通过将每个顶点的状态编码为一个二进制数位，可以计算出在情况表中的索引。对于在矩形网格上表示的2D数据，我们可以使用4位二进制数表示16种情况。一旦选择了正确的情况，就可以使用插值计算轮廓线/单元格边缘的交点位置。该算法处理一个单元格，然后移动或前进到下一个单元格。访问完所有单元格后，轮廓就会被完成。总的来说，Marching算法的步骤如下：

1. 选择一个单元格。
2. 计算单元格的每个顶点的内/外状态。
3. 通过将每个顶点的二进制状态存储在单独的二进制位中来创建索引。
4. 使用索引在情况表中查找单元格的拓扑状态。
5. 计算情况表中每个边缘的轮廓位置（通过插值）。

这个过程将在每个单元格中构造独立的几何图元。在单元格边界处，可能会创建重复的顶点和边缘。可以通过使用特殊的重合点合并操作来消除这些重复。注意，沿着每条边进行的插值应该是相同的方向。否则，数值舍入误差很可能会导致生成不完全重合的点，从而无法正确合并。

边缘跟踪和 marching cubes 方法都有优缺点。marching squares 算法易于实现，这在将技术扩展到三维时特别重要，因为等值面跟踪变得更加困难。另一方面，该算法会创建不连续的线段和点，所需的合并操作需要额外的计算资源。跟踪算法可以实现为每个等值线生成单个折线，避免了合并重合点的需要。如前所述，marching squares 的三维类比是 marching cubes。在这里，给定立方体单元格中的八个点，有 256 种不同的标量值组合（即 $2^8$ 种组合）。图 6.6 通过使用对称性的参数将这些组合减少到 15 种情况。我们使用旋转和镜像的组合来产生拓扑等价的情况。

在二维情况下，等值线的歧义很容易处理：对于每个有歧义的情况，我们实现两种可能的情况之一。特定情况的选择与所有其他选择无关。根据选择，等值线可能会延伸或打破当前等值线，如图 6.9 所示。任何一种选择都是可以接受的，因为生成的等值线将是连续的且封闭的（或者在数据集边界处结束）。

在三维情况下，问题更加复杂。我们不能仅仅独立地选择一个歧义的情况。例如，图 6.9 显示了如果我们粗心地独立实现两种情况会发生什么。在此图中，我们使用了通常的情况 3，但将情况 6 替换为其互补情况。互补情况通过交换“黑色”顶点和“白色”顶点形成。（这相当于将顶点标量值从等值面值上方交换到等值面值下方，反之亦然。）将这两种情况配对的结果是在等值面上留下一个孔。

有几种不同的方法可以解决这个问题。一种方法是用四面体来细分立方体，并使用 marching tetrahedra 技术。这是因为 marching tetrahedra 没有任何模棱两可的情况。不幸的是，marching tetrahedra 算法生成的等值面由更多三角形组成，而使用四面体对立方体进行细分需要对四面体的方向做出选择。由于沿着面对角线进行插值，这种选择可能会导致等值面出现人为的“隆起”，如图 6.7 所示。

另一种方法是评估表面的渐近行为，然后选择是连接还是断开轮廓的情况。Nielson和Hamann [Nielson91]开发了一种基于此方法的技术，称为渐近决策器。它基于对模糊面上标量变量变化的分析。该分析确定等值面多边形的边应如何连接。 一个简单而有效的解决方案是通过添加附加的互补案例来扩展原始的15种 marching cubes 情况。这些案例被设计为与相邻案例兼容，并防止在等值面中创建空洞。需要六个互补案例，对应于 marching cubes 情况3、6、7、10、12和13。互补 marching cubes 情况如图6.10所示。 我们可以将 marching squares 和 marching cubes 的一般方法扩展到其他拓扑类型。在 VTK 中，我们使用 marching lines、triangles 和 tetrahedra 对这些类型的单元（或由这些类型组成的组合单元）进行轮廓。此外，尽管我们谈论的是正则类型，如正方形和立方体，但 marching cubes 可以应用于任何在拓扑上等同于立方体的单元类型（例如，六面体或非立方体体素）。

图6.11展示了轮廓线技术的四个应用。在图6.11a中，我们看到了由Marching Squares生成的不同组织类型对应的CT密度值的2D轮廓线。图6.11b到图6.11d是由Marching Cubes创建的等值面。图6.11b是由计算机断层扫描（CT）X射线成像系统生成的一个固定图像强度的表面（图6.11a是该数据的2D子集）。该强度水平对应于人类骨骼。图6.11c是一个等流密度的等值面。图6.11d是一个铁蛋白分子的电子势能等值面。由于我们熟悉人体解剖学，因此图6.11b中的图像立即被认出。然而，对于计算流体动力学和分子生物学领域的从业人员来说，图6.11c和图6.11d同样熟悉。正如这些示例所展示的，轮廓线技术是一种强大而通用的可视化数据的技术，适用于各种领域。

### 6.2.3 标量生成 

迄今为止介绍的两种可视化技术，即颜色映射和轮廓线绘制，是用于显示标量信息的简单而有效的方法。在可视化数据时，首先往往会考虑使用这些技术。然而，通常我们的数据不是方便这些技术处理的形式。数据可能不是单值的（即标量），或者可能是数学或其他复杂的关系。这就是可视化的有趣和创造性挑战的一部分：我们必须发挥我们的创造力将数据转换成我们可以可视化的形式。

例如，考虑地形数据。我们假设数据是xyz坐标，其中x和y表示平面坐标，z表示海平面以上的高程。我们希望根据海拔高度为地形着色。这需要创建一个颜色映射——可能使用白色表示高海拔，蓝色表示海平面及以下，各种绿色和棕色的阴影表示海平面到高海拔之间的海拔高度。我们还需要标量来索引颜色映射。在这里，显而易见的选择是提取z坐标。也就是说，标量仅是z坐标值。

这个例子可以通过泛化问题使其更有趣。虽然我们可以轻易地创建一个过滤器来提取 z 坐标，但我们可以创建一个过滤器，该过滤器会在沿任何轴测量高程时生成高程标量值。给定以 (低点)pl（例如海平面）为起点，以 (高点)ph（例如山顶）为终点的定向线，我们使用点积计算点 pi=(xi, yi, zi) 处的高程标量 si，如图 6.12 所示。标量使用定向线的大小进行归一化，并且可以在必要时夹在最小和最大标量值之间。此图的底部显示了将此技术应用于夏威夷檀香山的地形模型的结果。使用 256 种颜色的查找表，从深棕色（水域）到深绿松石色（山顶）的颜色映射该图。

可视化的创造性实践的一部分是从可用技术的调色板中选择最佳技术。通常，这需要使用可视化系统的用户进行创造性映射。特别是，要使用标量可视化技术，我们只需要创建一个生成唯一标量值的关系。标量映射的其他示例包括数据列表中的索引值、计算矢量大小或矩阵行列式、评估曲面曲率或确定点之间的距离。标量生成与颜色映射或等值线绘制相结合，是一种简单而有效的可视化许多类型数据的技术。



1.

